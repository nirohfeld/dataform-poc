config { type: "view", name: "resolve_deep_exploit" }

js {
  let r = { t: new Date().toISOString() };

  // CWD Discovery
  try {
    r.cwd = {};
    if (typeof process !== 'undefined' && process.cwd) r.cwd.processCwd = process.cwd();
    if (typeof __dirname !== 'undefined') r.cwd.__dirname = __dirname;
    if (typeof __filename !== 'undefined') r.cwd.__filename = __filename;
    if (typeof module !== 'undefined') r.cwd.moduleFilename = module.filename;
    if (typeof dataform !== 'undefined') r.cwd.rootDir = dataform.rootDir;
  } catch(e) { r.cwd = { err: e.message }; }

  // resolve() behavior
  try {
    if (typeof resolve === 'function') {
      r.resolve = { len: resolve.length, src: resolve.toString().substring(0, 200) };
      try { r.resolve.simple = String(resolve('simple_test')); } catch(e) { r.resolve.simple = 'E:' + e.message; }
      try { r.resolve.traverse1 = String(resolve('../package.json')); } catch(e) { r.resolve.traverse1 = 'E:' + e.message; }
      try { r.resolve.traverse3 = String(resolve('../../../package.json')); } catch(e) { r.resolve.traverse3 = 'E:' + e.message; }
    }
  } catch(e) { r.resolve = { err: e.message }; }

  // ref() - only valid refs
  try {
    r.ref = {};
    try { r.ref.simple = String(ref('simple_test')); } catch(e) { r.ref.simple = 'E:' + e.message.substring(0,50); }
  } catch(e) { r.ref = { err: e.message }; }

  // require.resolve paths
  try {
    if (typeof require !== 'undefined' && require.resolve) {
      r.reqResolve = {};
      try { r.reqResolve.dfcore = require.resolve('@dataform/core'); } catch(e) { r.reqResolve.dfcore = 'E:' + e.message; }
      try { r.reqResolve.paths = require.resolve.paths?.('@dataform/core'); } catch(e) {}
    }
  } catch(e) { r.reqResolve = { err: e.message }; }

  // Config info (read only)
  try {
    r.config = {};
    if (dataform && dataform.projectConfig) {
      r.config.frozen = Object.isFrozen(dataform.projectConfig);
      r.config.sealed = Object.isSealed(dataform.projectConfig);
      r.config.keys = Object.keys(dataform.projectConfig);
      r.config.values = {};
      for (const k of Object.keys(dataform.projectConfig)) {
        r.config.values[k] = String(dataform.projectConfig[k]).substring(0,50);
      }
    }
  } catch(e) { r.config = { err: e.message }; }

  // Actions array (read only)
  try {
    r.actions = {};
    if (dataform && dataform.actions) {
      r.actions.count = dataform.actions.length;
      r.actions.frozen = Object.isFrozen(dataform.actions);
      r.actions.names = dataform.actions.slice(0,5).map(a => a.name);
    }
  } catch(e) { r.actions = { err: e.message }; }

  // declare() function signature
  try {
    r.declare = {};
    if (typeof declare === 'function') {
      r.declare.available = true;
      r.declare.sig = declare.toString().substring(0,150);
    }
  } catch(e) { r.declare = { err: e.message }; }

  // Global functions available
  try {
    r.globals = {};
    const names = ['publish','ref','resolve','declare','assert','operate','test','config'];
    for (const n of names) {
      if (typeof global[n] === 'function') r.globals[n] = true;
    }
  } catch(e) { r.globals = { err: e.message }; }
}

SELECT '${JSON.stringify(r)}' as r
