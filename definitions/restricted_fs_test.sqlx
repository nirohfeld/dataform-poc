-- Restricted FS & VM Test
-- Tests if we can read files or escape via vm.compileModule

config {
  type: "view",
  name: "restricted_fs_vm_test"
}

js {
  let results = [];

  // Test 1: List restricted_fs methods
  try {
    const methods = Object.keys(restricted_fs);
    results.push("1_FS_methods: " + methods.join(","));
  } catch(e) {
    results.push("1_FS_methods: FAIL - " + e.message);
  }

  // Test 2: List vm methods
  try {
    const methods = Object.keys(vm);
    results.push("2_VM_methods: " + methods.join(","));
  } catch(e) {
    results.push("2_VM_methods: FAIL - " + e.message);
  }

  // Test 3: Get __dirname
  try {
    results.push("3_Dirname: " + __dirname);
  } catch(e) {
    results.push("3_Dirname: FAIL - " + e.message);
  }

  // Test 4: Get __filename
  try {
    results.push("4_Filename: " + __filename);
  } catch(e) {
    results.push("4_Filename: FAIL - " + e.message);
  }

  // Test 5: Check if file exists
  try {
    const exists = restricted_fs.exists(__filename);
    results.push("5_FileExists: " + exists);
  } catch(e) {
    results.push("5_FileExists: FAIL - " + e.message);
  }

  // Test 6: Try to read a file
  try {
    const content = restricted_fs.readFile(__filename);
    results.push("6_ReadFile: " + (content ? "SUCCESS len=" + content.length : "EMPTY"));
  } catch(e) {
    results.push("6_ReadFile: FAIL - " + e.message);
  }

  // Test 7: Try to read /etc/passwd
  try {
    const content = restricted_fs.readFile("/etc/passwd");
    results.push("7_ReadPasswd: SUCCESS - " + content.substring(0, 100));
  } catch(e) {
    results.push("7_ReadPasswd: FAIL - " + e.message);
  }

  // Test 8: Try to read env file
  try {
    const content = restricted_fs.readFile("/proc/self/environ");
    results.push("8_ReadEnv: SUCCESS - " + content.substring(0, 200));
  } catch(e) {
    results.push("8_ReadEnv: FAIL - " + e.message);
  }

  // Test 9: Try vm.compileModule
  try {
    const mod = vm.compileModule("return 1+1");
    results.push("9_CompileModule: " + typeof mod);
  } catch(e) {
    results.push("9_CompileModule: FAIL - " + e.message);
  }

  // Test 10: Try vm.compileModule with process access
  try {
    const mod = vm.compileModule("return typeof process");
    results.push("10_CompileProcess: " + (mod ? mod() : "null"));
  } catch(e) {
    results.push("10_CompileProcess: FAIL - " + e.message);
  }

  // Test 11: isDirectory
  try {
    const isDir = restricted_fs.isDirectory("/");
    results.push("11_IsDir: " + isDir);
  } catch(e) {
    results.push("11_IsDir: FAIL - " + e.message);
  }

  // Test 12: Check for readFileSync
  try {
    if (restricted_fs.readFileSync) {
      const content = restricted_fs.readFileSync("/etc/hostname");
      results.push("12_ReadFileSync: " + content);
    } else {
      results.push("12_ReadFileSync: NOT_EXISTS");
    }
  } catch(e) {
    results.push("12_ReadFileSync: FAIL - " + e.message);
  }

  // Test 13: Check InternalError
  try {
    const ie = new InternalError("test");
    results.push("13_InternalError: " + ie.message + ", stack=" + (ie.stack ? "yes" : "no"));
  } catch(e) {
    results.push("13_InternalError: FAIL - " + e.message);
  }

  // Test 14: _internalError function
  try {
    const result = _internalError("test");
    results.push("14_InternalErrorFn: " + typeof result);
  } catch(e) {
    results.push("14_InternalErrorFn: FAIL - " + e.message);
  }

  // Test 15: Check core object
  try {
    const keys = Object.keys(core).slice(0, 10);
    results.push("15_Core: " + keys.join(","));
  } catch(e) {
    results.push("15_Core: FAIL - " + e.message);
  }
}

SELECT
  '${JSON.stringify(results)}' as fs_vm_results
