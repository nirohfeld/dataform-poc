config { type: "view", name: "v8_wasm_exploit" }

js {
  let results = [];

  // Test 1: WASM capabilities
  try {
    results.push('1_wasm_exists: ' + (typeof WebAssembly));
    results.push('1_wasm_keys: ' + Object.keys(WebAssembly).join(','));
  } catch(e) {
    results.push('1_wasm: ' + e.message);
  }

  // Test 2: Compile and instantiate simple WASM
  try {
    // Minimal WASM module: (module (func (export "test") (result i32) i32.const 42))
    const wasmBytes = new Uint8Array([
      0x00, 0x61, 0x73, 0x6d, // magic
      0x01, 0x00, 0x00, 0x00, // version
      0x01, 0x05, 0x01, 0x60, 0x00, 0x01, 0x7f, // type section
      0x03, 0x02, 0x01, 0x00, // function section
      0x07, 0x08, 0x01, 0x04, 0x74, 0x65, 0x73, 0x74, 0x00, 0x00, // export section
      0x0a, 0x06, 0x01, 0x04, 0x00, 0x41, 0x2a, 0x0b // code section
    ]);

    const module = new WebAssembly.Module(wasmBytes);
    const instance = new WebAssembly.Instance(module);
    results.push('2_wasm_test: ' + instance.exports.test());
  } catch(e) {
    results.push('2_wasm_compile: ' + e.message.substring(0, 100));
  }

  // Test 3: WASM memory access
  try {
    const memory = new WebAssembly.Memory({ initial: 1 });
    const view = new Uint8Array(memory.buffer);
    view[0] = 0x41;
    results.push('3_wasm_memory: size=' + memory.buffer.byteLength + ', first=' + view[0]);
  } catch(e) {
    results.push('3_memory: ' + e.message);
  }

  // Test 4: WASM with imports (could leak host functions)
  try {
    const imports = {
      env: {
        log: (x) => { results.push('wasm_called_log: ' + x); return x; }
      }
    };

    // WASM that calls imported function
    const wasmWithImport = new Uint8Array([
      0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00,
      0x01, 0x08, 0x02, 0x60, 0x01, 0x7f, 0x01, 0x7f, 0x60, 0x00, 0x01, 0x7f,
      0x02, 0x0b, 0x01, 0x03, 0x65, 0x6e, 0x76, 0x03, 0x6c, 0x6f, 0x67, 0x00, 0x00,
      0x03, 0x02, 0x01, 0x01,
      0x07, 0x08, 0x01, 0x04, 0x63, 0x61, 0x6c, 0x6c, 0x00, 0x01,
      0x0a, 0x08, 0x01, 0x06, 0x00, 0x41, 0x63, 0x10, 0x00, 0x0b
    ]);

    const mod = new WebAssembly.Module(wasmWithImport);
    const inst = new WebAssembly.Instance(mod, imports);
    results.push('4_wasm_import: ' + inst.exports.call());
  } catch(e) {
    results.push('4_wasm_import: ' + e.message.substring(0, 100));
  }

  // Test 5: Check for WASM streaming (network access)
  try {
    results.push('5_wasm_streaming: ' + (typeof WebAssembly.compileStreaming));
    results.push('5_wasm_instantiateStreaming: ' + (typeof WebAssembly.instantiateStreaming));
  } catch(e) {
    results.push('5_streaming: ' + e.message);
  }
}

SELECT '${JSON.stringify(results)}' as wasm_exploit_results
